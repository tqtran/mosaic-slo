# MOSAIC Source Directory

This directory contains all operational files for the MOSAIC platform. The `src/` directory is designed to be deployed as the complete application to a web server.

## Directory Structure

```text
src/
├── index.php                    # Front controller (application entry point)
├── .htaccess                    # Apache configuration and security
├── setup/
│   └── index.php                # Web-based database setup wizard
├── includes/
│   ├── header.php               # Common framework asset loader
│   ├── footer.php               # Common JavaScript loader
│   └── message_page.php         # Error/success page helper
├── config/
│   └── config.yaml              # Application configuration (generated by setup)
├── database/
│   └── schema.sql               # Complete MySQL schema
├── Core/
│   ├── Config.php               # Configuration loader
│   ├── Logger.php               # Logging system
│   └── Model.php                # Base model class (planned)
├── Models/                      # Data models (planned)
├── controllers/                 # Request handlers (planned)
├── views/                       # Templates (planned)
└── Exceptions/                  # Custom exceptions (planned)
```

## Deployment

The entire `src/` directory can be deployed to a web server. This is the **only directory** that should be deployed to production.

### Recommended Server Configuration

#### Apache (.htaccess in src/)

```apache
# Deny access to sensitive files
<FilesMatch "(config\.yaml|setup\.php|\.sql)$">
    Require all denied
</FilesMatch>

# PHP settings
php_value upload_max_filesize 10M
php_value post_max_size 10M
php_value memory_limit 128M
```

#### Nginx

```nginx
location ~ (config\.yaml|setup\.php|\.sql)$ {
    deny all;
}

location ~ \.php$ {
    fastcgi_pass unix:/var/run/php/php8.1-fpm.sock;
    fastcgi_index index.php;
    include fastcgi_params;
    fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
}
```

## Initial Setup

### 1. Database Initialization

1. Browse to your MOSAIC installation in a web browser
2. You'll be redirected to `/setup/`
3. Enter your MySQL database credentials
4. Click "Install MOSAIC"

This creates:

- Database with UTF8MB4 charset
- All tables (24 tables including logging)
- Standard roles
- `src/config/config.yaml` with database credentials
- Protected config directory with `.htaccess`

**Note:** Authentication system is in development. For now, all pages are accessible without login.

### 2. Start Development Server

```powershell
# From project root
php -S localhost:8000 -t src/
```

Access at: `http://localhost:8000/`

## Security Considerations

### File Permissions (Production)

```bash
# Restrict config file
chmod 600 src/config/config.yaml

# Setup directory should be deleted or moved after initial setup
chmod 700 src/setup/  # Or remove entirely

# Web-accessible files
chmod 755 src/
chmod 644 src/index.php
chmod 644 src/.htaccess
```

### Environment-Specific Configuration

Edit `src/config/config.yaml`:

#### Development

```yaml
app:
  debug: true
  
session:
  cookie_secure: false  # Non-HTTPS local development
```

#### Production

```yaml
app:
  debug: false
  
session:
  cookie_secure: true   # HTTPS only
```

### Disable Direct Script Access (Production)

After initial setup, you should:

1. **Delete setup/ directory** - no longer needed after installation
2. **Secure config directory** - .htaccess protection is created by setup wizard
3. **Restrict database/ access** via web server configuration

Example production structure:

```text
/opt/mosaic/
  └── src/           # Webroot points here
      ├── index.php  # Public entry point (front controller)
      ├── .htaccess  # Apache security and routing
      ├── includes/  # Common framework includes
      ├── config/    # Protected by .htaccess
      └── ...
```

## Maintenance

Log cleanup and other maintenance tasks will be available through the administration interface.

For manual database log cleanup if needed:

```sql
-- Keep logs for 90 days
DELETE FROM audit_log WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY);
DELETE FROM error_log WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY) AND is_resolved = 1;
DELETE FROM security_log WHERE created_at < DATE_SUB(NOW(), INTERVAL 90 DAY) AND is_threat = 0;
```

## Additional Documentation

- **Setup Guide**: `../setup/README.md`
- **Schema Documentation**: `../docs/concepts/SCHEMA.md`
- **Security Guide**: `../docs/concepts/SECURITY.md`
- **Logging Guide**: `../docs/implementation/LOGGING.md`
- **Architecture**: `../docs/concepts/ARCHITECTURE.md`
